import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:image_picker/image_picker.dart';
import 'dart:io';
import 'package:flutter/services.dart';
import 'package:emoji_picker_flutter/emoji_picker_flutter.dart';

// TODO: Replace with your Firebase configuration
const firebaseConfig = {
  "apiKey": "<API_KEY>",
  "authDomain": "<PROJECT_ID>.firebaseapp.com",
  "projectId": "<PROJECT_ID>",
  "storageBucket": "<PROJECT_ID>.appspot.com",
  "messagingSenderId": "<SENDER_ID>",
  "appId": "<APP_ID>"
};

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp();
  runApp(const SecretChatApp());
}

class SecretChatApp extends StatelessWidget {
  const SecretChatApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'SECRET CHAT',
      theme: ThemeData.light(),
      darkTheme: ThemeData.dark(),
      home: const LoginScreen(),
    );
  }
}

// ---------------- Login Screen ----------------
class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  bool loading = false;

  Future<void> _loginAnon() async {
    setState(() => loading = true);
    UserCredential user = await FirebaseAuth.instance.signInAnonymously();
    if (user.user != null) {
      final uid = user.user!.uid;
      final usersRef = FirebaseFirestore.instance.collection('users');
      await usersRef.doc(uid).set({
        'uid': uid,
        'name': 'Anonymous',
        'photoUrl': '',
        'lastSeen': FieldValue.serverTimestamp(),
      }, SetOptions(merge: true));
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(builder: (_) => HomeScreen(uid: uid)),
      );
    }
    setState(() => loading = false);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: loading
            ? const CircularProgressIndicator()
            : ElevatedButton(
                onPressed: _loginAnon,
                child: const Text("Login Anonymously"),
              ),
      ),
    );
  }
}

// ---------------- Home Screen ----------------
class HomeScreen extends StatelessWidget {
  final String uid;
  const HomeScreen({super.key, required this.uid});

  @override
  Widget build(BuildContext context) {
    final usersRef = FirebaseFirestore.instance.collection('users');
    return Scaffold(
      appBar: AppBar(title: const Text("SECRET CHAT")),
      body: StreamBuilder<QuerySnapshot>(
        stream: usersRef.snapshots(),
        builder: (context, snapshot) {
          if (!snapshot.hasData) return const Center(child: CircularProgressIndicator());
          final users = snapshot.data!.docs.where((doc) => doc.id != uid).toList();
          if (users.isEmpty) return const Center(child: Text("No other users"));
          return ListView.builder(
            itemCount: users.length,
            itemBuilder: (_, i) {
              final user = users[i];
              final lastSeen = (user['lastSeen'] as Timestamp?)?.toDate() ?? DateTime.now();
              final online = DateTime.now().difference(lastSeen).inMinutes < 1;
              return ListTile(
                leading: CircleAvatar(
                  backgroundImage: user['photoUrl'] != '' ? NetworkImage(user['photoUrl']) : null,
                  child: user['photoUrl'] == '' ? const Icon(Icons.person) : null,
                ),
                title: Text(user['name']),
                subtitle: Text(online ? "Online" : "Last seen: ${lastSeen.hour}:${lastSeen.minute}"),
                onTap: () {
                  final chatId = uid.hashCode <= user['uid'].hashCode
                      ? '${uid}_${user['uid']}'
                      : '${user['uid']}_$uid';
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                        builder: (_) => ChatScreen(
                              uid: uid,
                              chatId: chatId,
                              peerName: user['name'],
                              peerPhoto: user['photoUrl'],
                            )),
                  );
                },
              );
            },
          );
        },
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () async {
          final picker = ImagePicker();
          final image = await picker.pickImage(source: ImageSource.gallery);
          if (image != null) {
            final file = File(image.path);
            final ref = FirebaseStorage.instance.ref().child('profile_photos/$uid.jpg');
            await ref.putFile(file);
            final url = await ref.getDownloadURL();
            await FirebaseFirestore.instance.collection('users').doc(uid).update({'photoUrl': url});
          }
        },
        child: const Icon(Icons.person),
      ),
    );
  }
}

// ---------------- Chat Screen ----------------
class ChatScreen extends StatefulWidget {
  final String uid;
  final String chatId;
  final String peerName;
  final String peerPhoto;
  const ChatScreen(
      {super.key,
      required this.uid,
      required this.chatId,
      required this.peerName,
      required this.peerPhoto});

  @override
  State<ChatScreen> createState() => _ChatScreenState();
}

class _ChatScreenState extends State<ChatScreen> {
  final TextEditingController _controller = TextEditingController();
  bool showEmoji = false;

  void _sendMessage() {
    final text = _controller.text.trim();
    if (text.isEmpty) return;
    final msgRef = FirebaseFirestore.instance.collection('messages');
    msgRef.add({
      'chatId': widget.chatId,
      'senderId': widget.uid,
      'text': text,
      'timestamp': FieldValue.serverTimestamp(),
      'seen': false,
    });
    FirebaseFirestore.instance.collection('chats').doc(widget.chatId).set({
      'last_message': text,
      'timestamp': FieldValue.serverTimestamp(),
    }, SetOptions(merge: true));
    _controller.clear();
  }

  void _pickEmoji(Emoji emoji) {
    _controller.text += emoji.emoji;
  }

  @override
  Widget build(BuildContext context) {
    final msgsRef = FirebaseFirestore.instance
        .collection('messages')
        .where('chatId', isEqualTo: widget.chatId)
        .orderBy('timestamp');
    return Scaffold(
      appBar: AppBar(
        title: Row(
          children: [
            CircleAvatar(
              backgroundImage: widget.peerPhoto != '' ? NetworkImage(widget.peerPhoto) : null,
              child: widget.peerPhoto == '' ? const Icon(Icons.person) : null,
            ),
            const SizedBox(width: 8),
            Text(widget.peerName),
          ],
        ),
      ),
      body: Column(
        children: [
          Expanded(
            child: StreamBuilder<QuerySnapshot>(
              stream: msgsRef.snapshots(),
              builder: (context, snapshot) {
                if (!snapshot.hasData) return const Center(child: CircularProgressIndicator());
                final messages = snapshot.data!.docs;
                return ListView.builder(
                  itemCount: messages.length,
                  itemBuilder: (_, i) {
                    final msg = messages[i];
                    final isMe = msg['senderId'] == widget.uid;
                    return Container(
                      alignment: isMe ? Alignment.centerRight : Alignment.centerLeft,
                      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                      child: Container(
                        decoration: BoxDecoration(
                          color: isMe ? Colors.blue : Colors.grey[300],
                          borderRadius: BorderRadius.circular(12),
                        ),
                        padding: const EdgeInsets.all(8),
                        child: Text(
                          msg['text'] ?? '',
                          style: TextStyle(color: isMe ? Colors.white : Colors.black),
                        ),
                      ),
                    );
                  },
                );
              },
            ),
          ),
          if (showEmoji)
            SizedBox(
              height: 250,
              child: EmojiPicker(
                onEmojiSelected: (category, emoji) => _pickEmoji(emoji),
              ),
            ),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 8),
            color: Colors.grey[200],
            child: Row(
              children: [
                IconButton(
                  icon: const Icon(Icons.emoji_emotions),
                  onPressed: () {
                    setState(() {
                      showEmoji = !showEmoji;
                      if (showEmoji) FocusScope.of(context).unfocus();
                    });
                  },
                ),
                Expanded(
                  child: TextField(
                    controller: _controller,
                    decoration: const InputDecoration(hintText: "Type a message"),
                  ),
                ),
                IconButton(onPressed: _sendMessage, icon: const Icon(Icons.send)),
              ],
            ),
          )
        ],
      ),
    );
  }
}